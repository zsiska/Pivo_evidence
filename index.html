<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>Evidence piv</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .dark-mode {
            background-color: #121212;
            color: #f0f0f0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .dark-mode tr:nth-child(even) {
            background-color: #1e1e1e;
        }
        button {
            padding: 6px 12px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        input[type="number"], input[type="text"] {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        #control-panel {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px 16px;
            align-items: center;
        }
        .highlight {
            background-color: gold;
            font-weight: bold;
        }
        .stats {
            margin-top: 16px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: #eef2ff;
            color: #1e3a8a;
            font-weight: bold;
        }
        .dark-mode .pill {
            background: #1f2937;
            color: #bfdbfe;
        }
        .columns {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-top: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 12px;
        }
        .panel h3 {
            margin-top: 0;
            margin-bottom: 8px;
        }
        ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        li {
            padding: 6px 8px;
            border-bottom: 1px dashed #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        .overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 24px;
            text-align: center;
        }
        .overlay .content {
            max-width: 800px;
            width: 100%;
        }
        .big {
            font-size: 64px;
            font-weight: 800;
            margin: 0 0 24px 0;
            line-height: 1.1;
        }
        .mid {
            font-size: 28px;
            margin: 0 0 24px 0;
        }
        .overlay .actions {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn-yes { background: #16a34a; }
        .btn-yes:hover { background: #15803d; }
        .btn-no { background: #dc2626; }
        .btn-no:hover { background: #b91c1c; }
        .badge {
            background: #e5e7eb;
            color: #111827;
            border-radius: 6px;
            padding: 2px 6px;
            font-size: 12px;
        }
        .dark-mode .badge {
            background: #374151;
            color: #e5e7eb;
        }
        .muted { color: #6b7280; font-size: 12px; }
        .dark-mode .muted { color: #9ca3af; }
        .row-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            justify-content: center;
        }
        .btn-mini {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
        }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .btn-danger { background: #ef4444; }
        .btn-danger:hover { background: #dc2626; }
        .color-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:6px; vertical-align:middle; }
        .name { outline: none; }
    </style>
</head>
<body>
    <h1>Evidence piv</h1>
    <button onclick="toggleDarkMode()">P≈ôepnout re≈æim</button>

    <div id="control-panel">
        <input type="text" id="newParticipant" placeholder="Jm√©no nov√©ho √∫ƒçastn√≠ka">
        <button onclick="addParticipant()">P≈ôidat √∫ƒçastn√≠ka</button>
        <button onclick="removeParticipant()">Odebrat posledn√≠ho</button>

        <label for="maxBeers" style="margin-left:12px;">Maxim√°ln√≠ poƒçet piv:</label>
        <input type="number" id="maxBeers" min="0" value="0" style="width:120px;">
        <span id="stockInfo" class="pill">Sklad: 0</span>

        <button class="btn-secondary" onclick="exportRankingPDF()">Export po≈ôad√≠ do PDF</button>
        <button class="btn-secondary" onclick="exportCSV()">Export CSV</button>
        <button class="btn-danger" onclick="clearAllPrompt()">Vyƒçistit formul√°≈ô</button>
    </div>

    <table id="participantsTable">
        <thead>
            <tr>
                <th>üèÖ</th>
                <th>Jm√©no</th>
                <th>Poƒçet piv</th>
                <th>Pod√≠l (%)</th>
                <th>Akce</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td class="medal"></td>
                <td contenteditable="false"><span class="color-dot"></span><span class="name" contenteditable="true">Adam</span></td>
                <td>0</td>
                <td>0%</td>
                <td>
                    <input type="number" min="1" value="1" style="width:60px;">
                    <div class="row-actions">
                        <button onclick="queueOrder(this)">Odebrat</button>
                        <button class="btn-secondary" onclick="subtractBeersAdmin(this)">Odeƒç√≠st (spr√°vce)</button>
                    </div>
                </td>
            </tr>
            <tr>
                <td class="medal"></td>
                <td contenteditable="false"><span class="color-dot"></span><span class="name" contenteditable="true">B√°ra</span></td>
                <td>0</td>
                <td>0%</td>
                <td>
                    <input type="number" min="1" value="1" style="width:60px;">
                    <div class="row-actions">
                        <button onclick="queueOrder(this)">Odebrat</button>
                        <button class="btn-secondary" onclick="subtractBeersAdmin(this)">Odeƒç√≠st (spr√°vce)</button>
                    </div>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="stats">
        <span class="pill">Vydan√Ωch: <strong id="servedCount">0</strong></span>
        <span class="pill">ƒåekaj√≠c√≠ch: <strong id="waitingCount">0</strong></span>
    </div>

    <div class="columns">
        <div class="panel">
            <h3>Rezervaƒçn√≠ fronta</h3>
            <ul id="queueList"></ul>
            <div class="muted">Nov√° objedn√°vka se zobraz√≠ na displeji a ƒçek√° na potvrzen√≠.</div>
        </div>
        <div class="panel">
            <h3>Vydan√° piva</h3>
            <ul id="servedList"></ul>
        </div>
        <div class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0;">ƒåekaj√≠c√≠ objedn√°vky</h3>
                <button class="btn-yes btn-mini" onclick="serveAllAvailableWaiting()">Vydat dostupn√© ƒçekaj√≠c√≠</button>
            </div>
            <ul id="waitingList"></ul>
        </div>
    </div>

    <canvas id="beerChart" width="400" height="200" style="margin-top:24px;"></canvas>

    <div id="overlay" class="overlay" role="dialog" aria-modal="true">
        <div class="content">
            <div class="big" id="overlayTitle"></div>
            <div class="mid" id="overlaySubtitle"></div>
            <div class="actions" id="overlayActions">
                <button class="btn-yes" id="btnYes">Ano, odebr√°no</button>
                <button class="btn-no" id="btnNo">Ne, neodebr√°no</button>
            </div>
            <div class="muted">Po potvrzen√≠ se objedn√°vka zap√≠≈°e mezi vydan√© nebo ƒçekaj√≠c√≠.</div>
        </div>
    </div>

    <script>
        let darkMode = false;

        // Sklad
        let maxBeersTotal = 0;
        let remainingBeers = 0;

        // Fronta objedn√°vek
        const orderQueue = [];

        // ƒåekaj√≠c√≠ objedn√°vky (lze dodateƒçnƒõ vydat)
        const waitingOrders = [];

        // Aktu√°ln√≠ objedn√°vka v potvrzovac√≠m overlay
        let activeOrder = null;

        // Spr√°vce k√≥d (konfigurovateln√Ω)
        const ADMIN_CODE_STORAGE_KEY = "evidence_piv_admin_code";
        function getAdminCode() {
            let code = localStorage.getItem(ADMIN_CODE_STORAGE_KEY);
            if (!code) {
                code = prompt("Nastavte k√≥d spr√°vce (min. 4 znaky):") || "";
                code = code.trim();
                if (code.length < 4) {
                    alert("K√≥d mus√≠ m√≠t alespo≈à 4 znaky.");
                    return null;
                }
                localStorage.setItem(ADMIN_CODE_STORAGE_KEY, code);
            }
            return code;
        }
        function verifyAdmin() {
            const code = getAdminCode();
            if (!code) return false;
            const input = prompt("Zadejte k√≥d spr√°vce:");
            return input === code;
        }

        // Barvy pro √∫ƒçastn√≠ky
        const COLOR_PALETTE = [
            "#ef4444","#f59e0b","#10b981","#3b82f6","#8b5cf6",
            "#ec4899","#14b8a6","#84cc16","#f97316","#06b6d4",
            "#a855f7","#22c55e","#eab308","#0ea5e9","#d946ef"
        ];
        const usedColors = new Set();

        function pickColor() {
            for (const c of COLOR_PALETTE) {
                if (!usedColors.has(c)) { usedColors.add(c); return c; }
            }
            const h = Math.floor(Math.random()*360);
            const c = `hsl(${h} 70% 50%)`;
            usedColors.add(c);
            return c;
        }

        function escapeHtml(text) {
            return String(text).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
        }

        function ensureRowSetup(row, forcedColor) {
            const nameCell = row.cells[1];
            const currentName = nameCell.querySelector(".name") ? nameCell.querySelector(".name").innerText : nameCell.innerText;
            if (!row.dataset.color) {
                row.dataset.color = forcedColor || pickColor();
            } else {
                usedColors.add(row.dataset.color);
            }
            nameCell.innerHTML =
                '<span class="color-dot" style="background:'+row.dataset.color+'"></span>' +
                '<span class="name" contenteditable="true">'+escapeHtml((currentName || "").trim())+'</span>';
        }

        function toggleDarkMode() {
            darkMode = !darkMode;
            document.body.classList.toggle("dark-mode", darkMode);
            saveState();
        }

        function setStock(newMax) {
            const alreadyServed = getTotalServedBeers();
            maxBeersTotal = Math.max(0, newMax);
            remainingBeers = Math.max(0, maxBeersTotal - alreadyServed);
            renderStock();
            saveState();
        }

        function renderStock() {
            const stockInfo = document.getElementById("stockInfo");
            stockInfo.textContent = "Sklad: " + remainingBeers + " / " + maxBeersTotal;
        }

        document.getElementById("maxBeers").addEventListener("input", (e) => {
            const val = parseInt(e.target.value);
            setStock(isNaN(val) ? 0 : val);
        });

        function sanitizeName(name) {
            const trimmed = (name || "").trim();
            return trimmed.length > 0 ? trimmed : null;
        }

        function addParticipant() {
            const raw = document.getElementById("newParticipant").value;
            const name = sanitizeName(raw);
            if (!name) {
                alert("Jm√©no nesm√≠ b√Ωt pr√°zdn√©.");
                return;
            }
            const table = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            const row = table.insertRow();
            row.innerHTML = '<td class="medal"></td><td></td><td>0</td><td>0%</td><td><input type="number" min="1" value="1" style="width:60px;"><div class="row-actions"><button onclick="queueOrder(this)">Odebrat</button><button class="btn-secondary" onclick="subtractBeersAdmin(this)">Odeƒç√≠st (spr√°vce)</button></div></td>';
            ensureRowSetup(row);
            row.querySelector(".name").innerText = name;
            document.getElementById("newParticipant").value = "";
            updatePercentages();
            updateMedals();
            updateChart();
            saveState();
        }

        function removeParticipant() {
            const table = document.getElementById("participantsTable").getElementsByTagName("tbody")[0];
            if (table.rows.length > 0) {
                table.deleteRow(-1);
                updatePercentages();
                updateMedals();
                updateChart();
                document.getElementById("servedCount").textContent = String(getTotalServedBeers());
                saveState();
            }
        }

        // Validace contenteditable jmen (nepr√°zdn√©)
        document.querySelector("#participantsTable tbody").addEventListener("focusin", (e) => {
            if (e.target && e.target.classList.contains("name")) {
                e.target.dataset.prev = e.target.innerText;
            }
        });
        document.querySelector("#participantsTable tbody").addEventListener("focusout", (e) => {
            if (e.target && e.target.classList.contains("name")) {
                const val = sanitizeName(e.target.innerText);
                if (!val) {
                    e.target.innerText = e.target.dataset.prev || "Nezn√°m√Ω";
                }
                updatePercentages();
                updateMedals();
                updateChart();
                saveState();
            }
        });

        // Odeƒçten√≠ piv s k√≥dem spr√°vce (vrac√≠ do skladu)
        function subtractBeersAdmin(button) {
            if (!verifyAdmin()) return;
            const row = button.closest("tr");
            const input = row.querySelector("input[type='number']");
            const toSubtract = parseInt(input.value);
            if (isNaN(toSubtract) || toSubtract <= 0) return;

            const countCell = row.cells[2];
            const current = parseInt(countCell.innerText) || 0;
            const delta = Math.min(current, toSubtract);
            if (delta <= 0) return;

            countCell.innerText = String(current - delta);

            // vr√°tit piva do skladu, ale ne p≈ôes maximum
            const newRemaining = Math.min(maxBeersTotal - getTotalServedBeers(), remainingBeers + delta);
            remainingBeers = Math.max(0, newRemaining);
            renderStock();

            document.getElementById("servedCount").textContent = String(getTotalServedBeers());

            updatePercentages();
            updateMedals();
            updateChart();
            saveState();
        }

        // Vytvo≈ôen√≠ objedn√°vky a okam≈æit√© upozornƒõn√≠ na sklad
        function queueOrder(button) {
            const row = button.parentElement.parentElement.parentElement;
            const name = sanitizeName(row.querySelector(".name")?.innerText);
            const input = row.cells[4].querySelector("input");
            const count = parseInt(input.value);
            if (!name) {
                alert("Jm√©no nesm√≠ b√Ωt pr√°zdn√©.");
                return;
            }
            if (isNaN(count) || count <= 0) return;

            // Okam≈æit√© upozornƒõn√≠ p≈ôed overlayem
            if (count > remainingBeers) {
                const goWaiting = confirm("Na skladƒõ nen√≠ dostatek piv. P≈ôesunout objedn√°vku do ƒçekaj√≠c√≠ch?");
                if (goWaiting) {
                    const waitingOrder = {
                        id: Date.now() + "-" + Math.random().toString(36).slice(2),
                        name,
                        count,
                        createdAt: new Date(),
                        rowRef: row,
                        reason: "Nedostatek na skladƒõ"
                    };
                    waitingOrders.unshift(waitingOrder);
                    const waitingCount = document.getElementById("waitingCount");
                    waitingCount.textContent = (parseInt(waitingCount.textContent) || 0) + waitingOrder.count;
                    renderWaitingList();
                    saveState();
                }
                return;
            }

            const order = {
                id: Date.now() + "-" + Math.random().toString(36).slice(2),
                name,
                count,
                createdAt: new Date(),
                rowRef: row
            };
            orderQueue.push(order);
            renderQueue();
            saveState();
            maybeShowNextOrder();
        }

        function renderQueue() {
            const list = document.getElementById("queueList");
            list.innerHTML = "";
            orderQueue.forEach(o => {
                const li = document.createElement("li");
                const left = document.createElement("span");
                left.textContent = o.name + " ‚Äî " + o.count + "√ó pivo";
                const right = document.createElement("span");
                right.className = "badge";
                right.textContent = timeHHMM(o.createdAt);
                li.appendChild(left);
                li.appendChild(right);
                list.appendChild(li);
            });
        }

        function timeHHMM(d) {
            const dt = (d instanceof Date) ? d : new Date(d);
            return dt.toLocaleTimeString("cs-CZ", { hour: "2-digit", minute: "2-digit" });
        }

        // Overlay a11y
        let lastFocusedElement = null;
        function showOverlayForOrder(order) {
            const overlay = document.getElementById("overlay");
            const title = document.getElementById("overlayTitle");
            const subtitle = document.getElementById("overlaySubtitle");
            title.textContent = order.name;
            subtitle.textContent = "Po≈æadavek: " + order.count + "√ó pivo";
            overlay.style.display = "flex";

            lastFocusedElement = document.activeElement;
            const focusable = Array.from(overlay.querySelectorAll("button"));
            if (focusable.length > 0) focusable[0].focus();

            function handleKey(e) {
                if (e.key === "Escape") {
                    e.preventDefault();
                    document.getElementById("btnNo").click();
                } else if (e.key === "Tab") {
                    const items = focusable;
                    if (items.length === 0) return;
                    const idx = items.indexOf(document.activeElement);
                    if (e.shiftKey) {
                        if (idx <= 0) {
                            e.preventDefault();
                            items[items.length - 1].focus();
                        }
                    } else {
                        if (idx === items.length - 1) {
                            e.preventDefault();
                            items[0].focus();
                        }
                    }
                }
            }
            overlay.dataset.keyHandler = "1";
            window.addEventListener("keydown", handleKey);
            overlay._cleanup = () => window.removeEventListener("keydown", handleKey);
        }

        function hideOverlay() {
            const overlay = document.getElementById("overlay");
            overlay.style.display = "none";
            if (overlay._cleanup) overlay._cleanup();
            if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
                lastFocusedElement.focus();
            }
        }

        function maybeShowNextOrder() {
            if (activeOrder) return;
            if (orderQueue.length === 0) return;
            activeOrder = orderQueue.shift();
            renderQueue();
            saveState();
            showOverlayForOrder(activeOrder);
        }

        document.getElementById("btnYes").addEventListener("click", () => {
            if (!activeOrder) return;
            const order = activeOrder;

            if (order.count > remainingBeers) {
                addWaiting(order, "Nedostatek na skladƒõ");
                activeOrder = null;
                hideOverlay();
                maybeShowNextOrder();
                return;
            }

            applyServe(order);
            addServed(order);
            activeOrder = null;
            hideOverlay();
            maybeShowNextOrder();
        });

        document.getElementById("btnNo").addEventListener("click", () => {
            if (!activeOrder) return;
            addWaiting(activeOrder, "Odm√≠tnuto");
            activeOrder = null;
            hideOverlay();
            maybeShowNextOrder();
        });

        function applyServe(order) {
            const row = order.rowRef;
            const countCell = row ? row.cells[2] : null;
            if (countCell) {
                countCell.innerText = (parseInt(countCell.innerText) || 0) + order.count;
            }

            remainingBeers = Math.max(0, remainingBeers - order.count);
            renderStock();

            document.getElementById("servedCount").textContent = String(getTotalServedBeers());
            updatePercentages();
            updateMedals();
            updateChart();
            saveState();
        }

        function addServed(order) {
            const servedList = document.getElementById("servedList");
            const li = document.createElement("li");
            const left = document.createElement("span");
            left.textContent = order.name + " ‚Äî " + order.count + "√ó pivo";
            const right = document.createElement("span");
            right.className = "badge";
            right.textContent = timeHHMM(new Date());
            li.appendChild(left);
            li.appendChild(right);
            servedList.prepend(li);

            document.getElementById("servedCount").textContent = String(getTotalServedBeers());
            saveState();
        }

        // ƒåekaj√≠c√≠ (lze dodateƒçnƒõ vydat)
        function addWaiting(order, reason) {
            const waitingOrder = {
                id: order.id || (Date.now() + "-" + Math.random().toString(36).slice(2)),
                name: order.name,
                count: order.count,
                createdAt: new Date(),
                rowRef: order.rowRef,
                reason: reason || "ƒåek√°"
            };
            waitingOrders.unshift(waitingOrder);

            const waitingCount = document.getElementById("waitingCount");
            waitingCount.textContent = (parseInt(waitingCount.textContent) || 0) + waitingOrder.count;

            renderWaitingList();
            saveState();
        }

        function renderWaitingList() {
            const waitingList = document.getElementById("waitingList");
            waitingList.innerHTML = "";
            waitingOrders.forEach(o => {
                const li = document.createElement("li");

                const leftWrap = document.createElement("div");
                leftWrap.style.display = "flex";
                leftWrap.style.flexDirection = "column";
                leftWrap.style.gap = "2px";

                const line1 = document.createElement("span");
                line1.textContent = o.name + " ‚Äî " + o.count + "√ó pivo";
                const line2 = document.createElement("span");
                line2.className = "muted";
                line2.textContent = (o.reason || "ƒåek√°") + " ‚Ä¢ " + timeHHMM(o.createdAt);
                leftWrap.appendChild(line1);
                leftWrap.appendChild(line2);

                const actions = document.createElement("div");
                actions.className = "row-actions";
                const btnServe = document.createElement("button");
                btnServe.className = "btn-mini btn-yes";
                btnServe.textContent = "Vydat";
                btnServe.onclick = () => serveWaiting(o.id);

                actions.appendChild(btnServe);

                li.appendChild(leftWrap);
                li.appendChild(actions);
                waitingList.appendChild(li);
            });
        }

        function serveWaiting(orderId) {
            const idx = waitingOrders.findIndex(o => o.id === orderId);
            if (idx === -1) return;
            const order = waitingOrders[idx];
            if (order.count > remainingBeers) {
                alert("Nedostateƒçn√Ω sklad pro vyd√°n√≠ t√©to objedn√°vky.");
                return;
            }

            applyServe(order);
            addServed(order);

            waitingOrders.splice(idx, 1);
            const waitingCount = document.getElementById("waitingCount");
            waitingCount.textContent = Math.max(0, (parseInt(waitingCount.textContent) || 0) - order.count);
            renderWaitingList();
            saveState();
        }

        // Hromadn√© vyd√°n√≠ v≈°ech ƒçekaj√≠c√≠ch, na kter√© staƒç√≠ sklad
        function serveAllAvailableWaiting() {
            if (waitingOrders.length === 0) return;

            const inOrder = [...waitingOrders].reverse();
            let servedTotalFromWaiting = 0;

            for (const o of inOrder) {
                if (o.count <= remainingBeers) {
                    const idx = waitingOrders.findIndex(w => w.id === o.id);
                    if (idx !== -1) {
                        applyServe(o);
                        addServed(o);
                        waitingOrders.splice(idx, 1);
                        servedTotalFromWaiting += o.count;
                    }
                }
                if (remainingBeers === 0) break;
            }

            if (servedTotalFromWaiting > 0) {
                const waitingCount = document.getElementById("waitingCount");
                waitingCount.textContent = Math.max(0, (parseInt(waitingCount.textContent) || 0) - servedTotalFromWaiting);
                renderWaitingList();
                saveState();
            }
        }

        function getTotalServedBeers() {
            const rows = document.querySelectorAll("#participantsTable tbody tr");
            let total = 0;
            rows.forEach(row => {
                total += parseInt(row.cells[2].innerText) || 0;
            });
            return total;
        }

        function updatePercentages() {
            const rows = document.querySelectorAll("#participantsTable tbody tr");
            let total = 0;
            rows.forEach(row => {
                total += parseInt(row.cells[2].innerText) || 0;
            });
            rows.forEach(row => {
                const count = parseInt(row.cells[2].innerText) || 0;
                const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                row.cells[3].innerText = percent + "%";
            });
        }

        // ≈òazen√≠ dle poƒçtu piv a po≈ôad√≠: üèÖü•àü•â, ostatn√≠ 4., 5., ...
        function updateMedals() {
            const rows = Array.from(document.querySelectorAll("#participantsTable tbody tr"));
            // Sestupnƒõ podle poƒçtu, p≈ôi shodƒõ abecednƒõ podle jm√©na (stabiln√≠ tie-breaker)
            rows.sort((a, b) => {
                const aCount = parseInt(a.cells[2].innerText) || 0;
                const bCount = parseInt(b.cells[2].innerText) || 0;
                if (bCount !== aCount) return bCount - aCount;
                const aName = (a.querySelector(".name")?.innerText || a.cells[1].innerText || "").trim();
                const bName = (b.querySelector(".name")?.innerText || b.cells[1].innerText || "").trim();
                return aName.localeCompare(bName, "cs");
            });

            rows.forEach((row, index) => {
                const medalCell = row.cells[0];
                row.classList.remove("highlight");

                if (index === 0) {
                    medalCell.innerText = "üèÖ";
                    row.classList.add("highlight");
                } else if (index === 1) {
                    medalCell.innerText = "ü•à";
                } else if (index === 2) {
                    medalCell.innerText = "ü•â";
                } else {
                    medalCell.innerText = (index + 1) + ".";
                }
            });

            const tbody = document.querySelector("#participantsTable tbody");
            rows.forEach(row => tbody.appendChild(row));
        }

        function updateChart() {
            const names = [];
            const counts = [];
            const colors = [];
            const rows = document.querySelectorAll("#participantsTable tbody tr");
            rows.forEach(row => {
                const n = row.querySelector(".name")?.innerText || row.cells[1].innerText;
                names.push(n);
                counts.push(parseInt(row.cells[2].innerText) || 0);
                colors.push(row.dataset.color || "#999999");
            });
            beerChart.data.labels = names;
            beerChart.data.datasets[0].data = counts;
            beerChart.data.datasets[0].backgroundColor = colors;
            beerChart.data.datasets[0].borderColor = colors;
            beerChart.update();
        }

        // Ulo≈æen√≠/obnoven√≠ stavu
        const STORAGE_KEY = "evidence_piv_state_v3";
        function saveState() {
            try {
                const participants = [];
                const rows = document.querySelectorAll("#participantsTable tbody tr");
                rows.forEach(row => {
                    participants.push({
                        name: row.querySelector(".name")?.innerText.trim() || row.cells[1].innerText.trim(),
                        count: parseInt(row.cells[2].innerText) || 0,
                        color: row.dataset.color || null
                    });
                });

                const state = {
                    darkMode,
                    maxBeersTotal,
                    remainingBeers,
                    participants,
                    waitingOrders: waitingOrders.map(o => ({
                        id: o.id,
                        name: o.name,
                        count: o.count,
                        createdAt: o.createdAt instanceof Date ? o.createdAt.toISOString() : o.createdAt,
                        reason: o.reason
                    })),
                    orderQueue: orderQueue.map(o => ({
                        id: o.id,
                        name: o.name,
                        count: o.count,
                        createdAt: o.createdAt instanceof Date ? o.createdAt.toISOString() : o.createdAt
                    })),
                    servedList: Array.from(document.querySelectorAll("#servedList li")).map(li => li.textContent),
                    servedCount: getTotalServedBeers(),
                    waitingCount: waitingOrders.reduce((sum, o) => sum + (o.count || 0), 0)
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            } catch (e) {
                console.warn("Nelze ulo≈æit stav:", e);
            }
        }

        function loadState() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (!raw) {
                    // ≈æ√°dn√Ω stav ‚Äî nastav barvy statick√Ωm ≈ô√°dk≈Øm
                    document.querySelectorAll("#participantsTable tbody tr").forEach(row => ensureRowSetup(row));
                    return;
                }

                const state = JSON.parse(raw);

                darkMode = !!state.darkMode;
                document.body.classList.toggle("dark-mode", darkMode);

                const tbody = document.querySelector("#participantsTable tbody");
                tbody.innerHTML = "";
                (state.participants || []).forEach(p => {
                    const row = tbody.insertRow();
                    row.innerHTML = '<td class="medal"></td><td></td><td>0</td><td>0%</td><td><input type="number" min="1" value="1" style="width:60px;"><div class="row-actions"><button onclick="queueOrder(this)">Odebrat</button><button class="btn-secondary" onclick="subtractBeersAdmin(this)">Odeƒç√≠st (spr√°vce)</button></div></td>';
                    row.cells[2].innerText = String(p.count || 0);
                    ensureRowSetup(row, p.color || undefined);
                    row.querySelector(".name").innerText = p.name || "";
                });

                maxBeersTotal = parseInt(state.maxBeersTotal) || 0;
                const computedRemaining = Math.max(0, maxBeersTotal - getTotalServedBeers());
                remainingBeers = typeof state.remainingBeers === "number" ? Math.min(state.remainingBeers, computedRemaining) : computedRemaining;
                document.getElementById("maxBeers").value = String(maxBeersTotal);
                renderStock();

                waitingOrders.length = 0;
                (state.waitingOrders || []).forEach(o => {
                    waitingOrders.push({
                        id: o.id,
                        name: o.name,
                        count: o.count,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        rowRef: findRowByName(o.name),
                        reason: o.reason || "ƒåek√°"
                    });
                });
                renderWaitingList();

                orderQueue.length = 0;
                (state.orderQueue || []).forEach(o => {
                    orderQueue.push({
                        id: o.id,
                        name: o.name,
                        count: o.count,
                        createdAt: o.createdAt ? new Date(o.createdAt) : new Date(),
                        rowRef: findRowByName(o.name)
                    });
                });
                renderQueue();

                const servedList = document.getElementById("servedList");
                servedList.innerHTML = "";
                (state.servedList || []).forEach(text => {
                    const li = document.createElement("li");
                    li.textContent = text;
                    servedList.appendChild(li);
                });

                document.getElementById("servedCount").textContent = String(getTotalServedBeers());
                const wCount = (state.waitingOrders || []).reduce((a, b) => a + (b.count || 0), 0);
                document.getElementById("waitingCount").textContent = String(wCount);

                updatePercentages();
                updateMedals();
                updateChart();

            } catch (e) {
                console.warn("Nelze naƒç√≠st stav:", e);
            }
        }

        function findRowByName(name) {
            const rows = document.querySelectorAll("#participantsTable tbody tr");
            for (const row of rows) {
                const n = row.querySelector(".name")?.innerText.trim() || row.cells[1].innerText.trim();
                if (n === name) return row;
            }
            return null;
        }

        function clearAllPrompt() {
            if (!verifyAdmin()) return;
            clearAll();
        }

        function clearAll() {
            // tabulka
            const tbody = document.querySelector("#participantsTable tbody");
            tbody.innerHTML = "";

            // ƒçekaj√≠c√≠
            waitingOrders.length = 0;
            document.getElementById("waitingList").innerHTML = "";
            document.getElementById("waitingCount").textContent = "0";

            // fronta
            orderQueue.length = 0;
            document.getElementById("queueList").innerHTML = "";

            // vydan√©
            document.getElementById("servedList").innerHTML = "";
            document.getElementById("servedCount").textContent = "0";

            // sklad
            maxBeersTotal = 0;
            remainingBeers = 0;
            document.getElementById("maxBeers").value = "0";
            renderStock();

            // graf a po≈ôad√≠
            updatePercentages();
            updateMedals();
            updateChart();

            // storage
            localStorage.removeItem(STORAGE_KEY);
        }

        // Export po≈ôad√≠ do PDF
        async function exportRankingPDF() {
            const rows = Array.from(document.querySelectorAll("#participantsTable tbody tr"));
            const ranking = rows.map((row, index) => {
                const name = row.querySelector(".name")?.innerText.trim() || row.cells[1].innerText.trim();
                const count = parseInt(row.cells[2].innerText) || 0;
                const share = row.cells[3].innerText.trim();
                let orderLabel = "";
                if (index === 0) orderLabel = "üèÖ";
                else if (index === 1) orderLabel = "ü•à";
                else if (index === 2) orderLabel = "ü•â";
                else orderLabel = (index + 1) + ".";
                return { order: orderLabel, name, count, share };
            });

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: "portrait", unit: "pt", format: "a4" });

            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.text("Evidence piv ‚Äî Po≈ôad√≠", 40, 40);

            doc.setFontSize(12);
            doc.setFont("helvetica", "normal");
            doc.text("Datum: " + new Date().toLocaleString("cs-CZ"), 40, 60);
            doc.text("Sklad: " + remainingBeers + " / " + maxBeersTotal, 40, 76);

            const body = ranking.map(r => [r.order, r.name, String(r.count), r.share]);
            doc.autoTable({
                head: [["Po≈ôad√≠", "Jm√©no", "Poƒçet piv", "Pod√≠l"]],
                body,
                startY: 100,
                styles: { font: "helvetica", fontSize: 11 },
                headStyles: { fillColor: [0, 123, 255] }
            });

            doc.save("poradi_piva.pdf");
        }

        // Export CSV
        function exportCSV() {
            const rows = Array.from(document.querySelectorAll("#participantsTable tbody tr"));
            const total = getTotalServedBeers();
            const header = ["Poradi","Jmeno","Pocet","Podil","MaxSklad","Zbyva","Datum"];
            const data = rows.map((row, index) => {
                let orderLabel = "";
                if (index === 0) orderLabel = "1";
                else if (index === 1) orderLabel = "2";
                else if (index === 2) orderLabel = "3";
                else orderLabel = String(index + 1);
                const name = (row.querySelector(".name")?.innerText.trim() || row.cells[1].innerText.trim()).replaceAll('"','""');
                const count = parseInt(row.cells[2].innerText) || 0;
                const share = total > 0 ? ((count / total) * 100).toFixed(1) + "%" : "0%";
                return [orderLabel, name, String(count), share, String(maxBeersTotal), String(remainingBeers), new Date().toLocaleString("cs-CZ")];
            });
            const csv = [header, ...data].map(r => r.map(v => `"${String(v)}"`).join(",")).join("\r\n");
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "evidence_piv.csv";
            a.click();
            URL.revokeObjectURL(url);
        }

        const ctx = document.getElementById("beerChart").getContext("2d");
        const beerChart = new Chart(ctx, {
            type: "bar",
            data: {
                labels: [],
                datasets: [{
                    label: "Poƒçet piv",
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true,
                        precision: 0
                    }
                }
            }
        });

        // Inicializace
        loadState();
        // pokud nebyl stav, barvy se p≈ôidaly v loadState; pokud stav byl, ≈ô√°dky u≈æ byly vytvo≈ôeny s barvou
        // pro jistotu refresh grafu
        updateChart();

        window.addEventListener("beforeunload", saveState);
    </script>
</body>
</html>
